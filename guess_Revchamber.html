<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>床衝撃音 再生ポータル（欠品表示つき）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    #plan-image {
      max-width: 50%;
      height: auto;
      border: 1px solid #ccc;
      margin-bottom: 1.5rem;
    }

    /* 音源選択 */
    #source-selector {
      margin-bottom: 1rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
      display: inline-block;
    }
    #source-selector label {
      margin-right: 1rem;
      cursor: pointer;
    }
    #source-selector span {
      font-weight: bold;
      margin-right: 0.5rem;
    }

    /* マトリクス（G…A × 5…1） */
    #matrix {
      margin-bottom: 1rem;
    }
    #matrix table {
      border-collapse: collapse;
    }
    #matrix th,
    #matrix td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
    }
    #matrix th {
      background: #f0f0f0;
      font-weight: bold;
    }
    .matrix-row-label {
      background: #f9f9f9;
      font-weight: bold;
      width: 30px;
    }
    .matrix-button {
      padding: 4px 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #f5f5f5;
      border-radius: 3px;
      font-size: 12px;
      width: 40px;
      box-sizing: border-box;
    }
    /* 特別位置用の色（F4, F2, D3, B4, B2） */
    .matrix-button.special-pos {
      background: #fff5c4;
      border-color: #e0b000;
    }
    .matrix-button.active {
      background: #4285f4;
      color: #fff;
      border-color: #3367d6;
      font-weight: bold;
    }

    /* 再生テーブル */
    #position-title {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    table.audio-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
    }
    table.audio-table th,
    table.audio-table td {
      border: 1px solid #aaa;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
    }
    table.audio-table th {
      background: #f0f0f0;
    }
    .row-label {
      width: 70px;
      font-weight: bold;
      background: #f9f9f9;
    }
    audio {
      width: 160px;
    }

    /* ファイル欠品セル表示 */
    .missing-cell {
      background: #eee;
      color: #999;
      font-size: 0.85rem;
    }

    .legend {
      font-size: 0.8rem;
      color: #555;
      margin-top: 0.5rem;
    }

    /* ===== なんちゃってロック用スタイル ===== */
    #lock-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #lock-panel {
      background: #ffffff;
      max-width: 600px;
      width: 90%;
      padding: 1.5rem 1.8rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    #lock-panel h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.4rem;
    }

    #lock-panel p {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .terms-box {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      max-height: 180px;
      overflow-y: auto;
      font-size: 0.85rem;
      background: #fafafa;
      margin-bottom: 0.75rem;
      white-space: pre-wrap;
    }

    .lock-field {
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .lock-field label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .lock-field input[type="password"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.5rem;
      font-size: 0.95rem;
    }

    .lock-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .lock-footer-left {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
    }

    #enter-button {
      padding: 0.4rem 1.2rem;
      font-size: 0.95rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #4285f4;
      color: #fff;
      font-weight: 600;
    }

    #enter-button:disabled {
      background: #c0c0c0;
      cursor: default;
    }

    #lock-error {
      margin-top: 0.4rem;
      font-size: 0.85rem;
      color: #c0392b;
      min-height: 1.1em;
    }
    /* ===== なんちゃってロック用スタイルここまで ===== */

  </style>
</head>
<body>
  <div id="lock-overlay">
    <div id="lock-panel">
      <h2>床衝撃音サンプル利用に関する利用条件の確認</h2>
      <p>
        このページでは、研究目的で取得した床衝撃音の実測データを再生できます。<br>
        ご利用にあたり、下記の条件をご確認のうえ、パスワードを入力してください。
      </p>

      <div class="terms-box">
        ・研究仲間にリンクを配るときの、最低限のマナー＆心理的ハードルとして設定しています。
        ・本音源は、配布者の検討や実験の過程を示すことを主な目的として提供しています。
        ・生データや本リンクの再配布、不特定多数への再公開を行わないでください。
        ・聞いてみる、自分で検討に使ってみる、これら以外の利用については配布者に相談してください。
        ・個別案件・商品等の宣伝目的での利用はご遠慮ください。
        ・本データの利用により生じた結果・損害等について、提供者は一切の責任を負いません。
      </div>

      <div class="lock-field">
        <label for="lock-password">パスワード</label>
        <input
          id="lock-password"
          type="password"
          autocomplete="off"
          placeholder="パスワードを入力してください"
        />
      </div>

      <div class="lock-footer">
        <div class="lock-footer-left">
          <input type="checkbox" id="agree-terms" />
          <label for="agree-terms">上記の利用条件に同意します</label>
        </div>
        <button id="enter-button" disabled>入室する</button>
      </div>

      <div id="lock-error"></div>
    </div>
  </div>
  <h1>床衝撃音サンプル再生 B 残響室床開口部</h1>
  <p>測定点配置図：</p>

  <img
    id="plan-image"
    src="audio/BRI_RevChamber/measurementlocation.png"
    alt="測定点配置図"
  />

  <div id="source-selector">
    <span>音源種類:</span>
    <label>
      <input type="radio" name="sourceType" value="tapping" checked />
      Tapping Machine
    </label>
    <label>
      <input type="radio" name="sourceType" value="tire" />
      Tire
    </label>
    <label>
      <input type="radio" name="sourceType" value="ball" />
      Ball
    </label>
    <label>
      <input type="radio" name="sourceType" value="hammer" />
      Hammer
    </label>
  </div>

  <p style="font-size: 0.85rem; color: #555; margin-top: 0;">
    ※表頭の「距離」はマイクロホンからの距離を示し、対応するチャンネル番号は音源ファイル名の末尾「CHx」に対応しています。<br>
    ※音源種類を切り替えると、現在選択中の位置のテーブルが再描画されます。<br>
    ※B2,B4,D3,F2,F4の測定位置はPatternAからJまで全ての音源ファイルが存在します。その他の測定位置にはパターンC,D,E,G,Iの測定結果がありません。
  </p>

  <div id="matrix"></div>

  <h2 id="position-title">測定位置 -</h2>

  <div id="audio-table-container"></div>
  <div class="legend"></div>

  <script>
    // ===== なんちゃってロック機能 =====
    const PASSWORD = "hirakawa";

    function hideLockOverlay() {
      const overlay = document.getElementById("lock-overlay");
      if (overlay) {
        overlay.style.display = "none";
      }
    }

    function setupLock() {
      const overlay = document.getElementById("lock-overlay");
      if (!overlay) return;

      const passwordInput = document.getElementById("lock-password");
      const agreeCheckbox = document.getElementById("agree-terms");
      const enterButton   = document.getElementById("enter-button");
      const errorEl       = document.getElementById("lock-error");

      function updateButtonState() {
        enterButton.disabled = !agreeCheckbox.checked;
      }

      agreeCheckbox.addEventListener("change", updateButtonState);

      enterButton.addEventListener("click", () => {
        const inputVal = passwordInput.value || "";
        errorEl.textContent = "";

        if (!agreeCheckbox.checked) {
          errorEl.textContent = "利用条件への同意が必要です。";
          return;
        }

        if (inputVal !== PASSWORD) {
          errorEl.textContent = "パスワードが違います。";
          passwordInput.focus();
          passwordInput.select();
          return;
        }

        // ここでは localStorage に保存せず、単にこのセッション分だけオーバーレイを消す
        hideLockOverlay();
      });

      // Enterキーでも送信できるように
      passwordInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          enterButton.click();
        }
      });
    }

    // ===== ここから元のプレーヤー用スクリプト =====

    // パターン A〜J
    const PATTERNS = ["A","B","C","D","E","F","G","H","I","J"];

    // 位置記号 A〜G, 番号 1〜5
    const POS_LETTERS = ["A","B","C","D","E","F","G"];
    const POS_NUMBERS = [1,2,3,4,5];

    // マトリクス表示用（横 G..A, 縦 5..1）
    const LETTERS_FOR_MATRIX = ["G","F","E","D","C","B","A"];
    const NUMBERS_FOR_MATRIX = [5,4,3,2,1];

    // 特別に色を変える位置
    const SPECIAL_POSITIONS = ["F4","F2","D3","B4","B2"];

    // 距離とチャンネル
    const DISTANCES = [
      { label: "10 cm",  ch: 4 },
      { label: "40 cm",  ch: 5 },
      { label: "70 cm",  ch: 6 },
      { label: "100 cm", ch: 7 },  // 100 cm
      { label: "130 cm", ch: 8 }
    ];

    // 音源種類ごとのフォルダ名 & ファイル名トークン
    // ★Hammerを追加しました
    const SOURCE_CONFIG = {
      tapping: { folder: "tapping", token: "tap"  },
      tire:    { folder: "tire",    token: "bang" },
      ball:    { folder: "ball",    token: "ball" },
      hammer:  { folder: "hammer",  token: "hammer" } 
    };

    let currentSourceType = "tapping";
    let currentPosition   = "A1";  // 初期位置

    function makeFilePath(sourceType, pattern, pos, ch) {
      const cfg = SOURCE_CONFIG[sourceType];
      // ★修正: DSをファイル名に追加      // 例: audio/BRI_RevChamber/tire/Pattern_A_bang_A1_DS_CH4.wav
      return `audio/BRI_RevChamber/${cfg.folder}/Pattern_${pattern}_${cfg.token}_${pos}_CH${ch}.wav`;
    }

    // ===== マトリクス作成 =====
    function createMatrix() {
      const container = document.getElementById("matrix");
      const table = document.createElement("table");

      // ヘッダ行（空白 + G..A）
      const headerTr = document.createElement("tr");
      const blankTh  = document.createElement("th");
      blankTh.textContent = "";
      headerTr.appendChild(blankTh);
      LETTERS_FOR_MATRIX.forEach(letter => {
        const th = document.createElement("th");
        th.textContent = letter;
        headerTr.appendChild(th);
      });
      table.appendChild(headerTr);

      // 各行（5..1）
      NUMBERS_FOR_MATRIX.forEach(num => {
        const tr = document.createElement("tr");

        const rowLabel = document.createElement("td");
        rowLabel.className = "matrix-row-label";
        rowLabel.textContent = num;
        tr.appendChild(rowLabel);

        LETTERS_FOR_MATRIX.forEach(letter => {
          const td = document.createElement("td");
          const pos = `${letter}${num}`;

          const btn = document.createElement("button");
          btn.className = "matrix-button";
          btn.dataset.pos = pos;
          btn.textContent = pos;

          // 特別位置ならクラスを追加
          if (SPECIAL_POSITIONS.includes(pos)) {
            btn.classList.add("special-pos");
          }

          btn.addEventListener("click", () => {
            currentPosition = pos;
            updateActiveButtons();
            renderPositionTable();
          });

          td.appendChild(btn);
          tr.appendChild(td);
        });

        table.appendChild(tr);
      });

      container.appendChild(table);
      updateActiveButtons(); // 初期 A1 を active に
    }

    function updateActiveButtons() {
      const buttons = document.querySelectorAll(".matrix-button");
      buttons.forEach(btn => {
        if (btn.dataset.pos === currentPosition) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    // ===== 再生テーブル描画 =====
    function renderPositionTable() {
      const titleEl   = document.getElementById("position-title");
      const container = document.getElementById("audio-table-container");

      titleEl.textContent = `測定位置 ${currentPosition}`;
      container.innerHTML = ""; // 一旦クリア

      const table = document.createElement("table");
      table.className = "audio-table";

      // thead
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      const emptyTh = document.createElement("th");
      headRow.appendChild(emptyTh);
      DISTANCES.forEach(d => {
        const th = document.createElement("th");
        th.textContent = d.label;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      // tbody
      const tbody = document.createElement("tbody");

      PATTERNS.forEach(pattern => {
        const tr = document.createElement("tr");

        const rowLabel = document.createElement("td");
        rowLabel.className = "row-label";
        rowLabel.textContent = `Pattern ${pattern}`;
        tr.appendChild(rowLabel);

        DISTANCES.forEach(d => {
          const td = document.createElement("td");

          const audio = document.createElement("audio");
          audio.controls = true;

          audio.dataset.pattern = pattern;
          audio.dataset.pos     = currentPosition;
          audio.dataset.ch      = String(d.ch);

          const src = makeFilePath(currentSourceType, pattern, currentPosition, d.ch);
          audio.src = src;

          // 読み込み失敗時：セルを「－」表示に置き換える
          audio.addEventListener("error", () => {
            td.classList.add("missing-cell");
            td.textContent = "－";
            // console.warn("Missing or unreadable audio file:", src);
          });

          td.appendChild(audio);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    // ===== 音源タイプ切り替え =====
    function setupSourceSelector() {
      const radios = document.querySelectorAll('input[name="sourceType"]');
      radios.forEach(radio => {
        radio.addEventListener("change", () => {
          if (!radio.checked) return;
          currentSourceType = radio.value;
          renderPositionTable(); // 現在位置を再描画
        });
      });
    }

    // ===== 初期化 =====
    document.addEventListener("DOMContentLoaded", () => {
      setupLock();          // なんちゃってロック初期化（毎回入力方式）
      createMatrix();
      setupSourceSelector();
      renderPositionTable(); // A1 から開始
    });
  </script>
</body>
</html>